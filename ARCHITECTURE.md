
# توثيق بنية مشروع PROMPT MASTER v4.1

هذا المستند يقدم تحليلاً شاملاً لبنية المشروع، بدءًا من التقنيات المستخدمة ووصولاً إلى منطق العمل الأساسي في توليد الأوامر (Prompts).

---

## 1. نظرة عامة والتقنيات الأساسية

المشروع هو تطبيق ويب متقدم (Single Page Application) مبني باستخدام أحدث تقنيات الواجهة الأمامية.

- **المكتبة الأساسية**: React (v18.2.0)
- **لغة البرمجة**: TypeScript
- **أداة البناء والتطوير**: Vite
- **التصميم**: Tailwind CSS (يتم تحميله عبر CDN مع بعض الأنماط المخصصة في `index.html`)
- **الخدمات الخلفية (BaaS)**: Firebase (للمصادقة Authentication وإدارة بيانات المستخدم)
- **الذكاء الاصطناعي**: Google AI / Gemini (`@google/genai`)
- **التنقل (Routing)**: نظام تنقل داخلي بسيط يعتمد على حالة React (State).
- **المدفوعات**: PayPal SDK مدمج.
- **الإعلانات**: Monetag لتحقيق الدخل.

---

## 2. هيكل المشروع (Project Structure)

المشروع منظم بشكل جيد في مجلدات متخصصة، مما يسهل فهمه وصيانته:

- **`/` (الجذر)**: يحتوي على ملفات الإعدادات الرئيسية (`vite.config.ts`, `package.json`) ونقطة بداية التطبيق (`index.html`, `index.tsx`). الأهم من ذلك، أنه يحتوي على الملف المركزي `prompt_master_v4.1.tsx`.
- **`/src`**: يحتوي على الكود المصدري الأساسي.
    - **`/src/context`**: لإدارة الحالات العامة في التطبيق، مثل `AuthContext` الذي يوفر معلومات المستخدم.
    - **`/src/locales`**: يحتوي على ملفات الترجمة لجميع اللغات (`en.ts`, `ar.ts`) وملف الأنواع الخاص بها (`types.ts`).
    - **`/src/services`**: يحتوي على منطق الأعمال المنفصل والخدمات، مثل التواصل مع Firebase (`coinsService.ts`).
- **`/components`**: يحتوي على جميع مكونات React القابلة لإعادة الاستخدام التي تشكل واجهة المستخدم.
    - **`/components/hooks`**: **هذا هو الجزء الأكثر أهمية.** يحتوي على خطافات مخصصة (Custom Hooks) تفصل المنطق المعقد عن واجهة المستخدم.
- **`/data`**: يحتوي على ملفات `JSON` التي تعمل كـ "قاعدة معرفة" ديناميكية لتوليد البرومبتات. هذا يسمح بتعديل منطق التوليد دون تغيير الكود.

---

## 3. تدفق تشغيل التطبيق (Application Flow)

1.  **`index.html`**: نقطة الدخول الأولى. يقوم بتحميل خطوط الويب، وأنماط CSS الأساسية، والسكريبتات الخارجية (PayPal, Tailwind)، والأهم من ذلك، يقوم بتحميل `index.tsx` داخل `<div id="root">`.
2.  **`index.tsx`**: يقوم بإنشاء جذر React (React Root) وعرض المكون الرئيسي للتطبيق.
3.  **`AuthProvider`**: يتم تغليف التطبيق بالكامل بهذا السياق (Context)، مما يجعل معلومات تسجيل الدخول متاحة في كل مكان.
4.  **`components/App.tsx`**: مكون بسيط يعمل كموجه. يقوم فقط بعرض المكون الفعلي للتطبيق.
5.  **`prompt_master_v4.1.tsx`**: **هذا هو الملف المركزي للتطبيق.** هو العقل المدبر الذي يجمع كل شيء:
    *   يستدعي جميع الخطافات المخصصة لإدارة الحالة.
    *   يعرض المكونات الأساسية (`Header`, `IdeaInput`, `SettingsPanel`, `ResultsDisplay`).
    *   يدير التنقل بين الصفحات (`main`, `favorites`, `history`, `subscription`).
    *   يتحكم في عرض جميع النوافذ المنبثقة (Modals).

---

## 4. المحرك الأساسي: هندسة توليد البرومبت

يكمن قلب المشروع في الطريقة التي يتم بها بناء وتوليد البرومبتات. هذه العملية منظمة بذكاء في طبقات متعددة.

### الطبقة الأولى: الواجهة والتحكم (`prompt_master_v4.1.tsx`)

-   عندما يضغط المستخدم على زر "Generate"، يتم استدعاء دالة `handleGenerateClick`.
-   تقوم هذه الدالة بتشغيل أنيميشن الصاروخ وتستدعي `handleGenerate` التي تم جلبها من الخطاف `usePromptGeneration`.

### الطبقة الثانية: التنسيق وإدارة الحالة (`usePromptGeneration.ts`)

-   هذا الخطاف المخصص هو **"منسق الأوركسترا"**.
-   يحدد وضع التوليد الحالي (`image`, `video`, `text`).
-   يجمع إعدادات المستخدم من الحالة (State).
-   **يفوض** مهمة بناء البرومبت إلى "مجمّع" (Assembler) متخصص بناءً على الوضع.

### الطبقة الثالثة: منطق التجميع المتخصص (`/services/*PromptAssembler.ts`)

-   **نمط المُجَمِّع (Assembler Pattern)**: بدلاً من وجود منطق بناء البرومبت في مكان واحد، يتم فصله إلى ملفات متخصصة:
    -   `imagePromptAssembler.ts`
    -   `videoPromptAssembler.ts`
    -   `textPromptAssembler.ts`
-   كل مجمّع مسؤول عن بناء البرومبت النهائي الخاص بنوعه فقط.

### الطبقة الرابعة: الخوارزمية النهائية (`imagePromptAssembler.ts`)

-   هذا هو "العقل" الحقيقي الذي يحتوي على الخوارزمية النهائية لبناء البرومبت المعقد.
-   **التحميل الديناميكي لقاعدة المعرفة**: قبل أي شيء، يقوم المجمّع بتحميل ملف `JSON` المناسب من مجلد `/data`. هذا الملف يحتوي على قوالب النصوص وأجزاء البرومبت. هذا يسمح بمرونة عالية.
-   **سير العمل المتقدم (Advanced Workflow)**:
    1.  **لعب الأدوار (Role-Playing)**: يبدأ البرومبت بتعريف "شخصية" للذكاء الاصطناعي (مثال: "أنت خبير في Midjourney...").
    2.  **قائمة تدقيق الجودة**: يضيف قائمة مراجعة للجودة تبدو كخطوات تفكير داخلية للنموذج.
    3.  **تجميع البرومبت الرئيسي**: يدمج وصف المستخدم مع الإعدادات التي اختارها.
    4.  **تطبيق نمط خاص**: إذا اختار المستخدم نمطًا معينًا (Style)، يتم إضافة "وحدة برمجية للبرومبت" (promptModule) خاصة بهذا النمط.
    5.  **البرومبت السلبي**: يضيف تعليمات لتجنب أشياء معينة.
    6.  **أمر الإنشاء النهائي**: ينتهي بأمر صريح للنموذج لبدء التوليد.

-   **النتيجة النهائية**: يتم إرجاع سلسلة نصية نهائية (`finalPrompt`) تبدو كأنها برومبت احترافي ومعقد تم بناؤه بواسطة خبير.

---
## 5. ملخص هيكلي
<img width="800" alt="CleanShot 2024-08-01 at 01 27 07@2x" src="https://github.com/user-attachments/assets/e17e0892-25e1-4c5e-88db-b09f481c471c">

---

## 6. الاستضافة والنشر (Hosting & Deployment)

- **منصة الاستضافة**: يتم استضافة هذا المشروع على **Vercel**.
- **النشر التلقائي (CI/CD)**: تم ربط المشروع بمستودع GitHub. أي عملية `git push` إلى الفرع الرئيسي (`main`) تؤدي تلقائيًا إلى بدء عملية بناء ونشر جديدة على Vercel. هذا يضمن أن آخر التحديثات والإصلاحات تصبح متاحة للمستخدمين بسرعة وكفاءة.
- **ملاحظة هامة**: لا حاجة لتنفيذ أوامر نشر يدوية. العملية مؤتمتة بالكامل عبر Vercel.

---

## 7. سجل التغييرات والتحسينات

### تحسين: توحيد وعرض الاستايلات الفنية بشكل ديناميكي

**المشكلة:** كانت الواجهة تحتوي على قائمتين منسدلتين مربكتين لاختيار الاستايل ("الاستايل" و "النمط"). كانت الااستايلات الجديدة (الـ 11) تُعرض في قائمة منفصلة مع وصف، بينما كانت الااستايلات الأساسية في قائمة أخرى بدون وصف، مما أدى إلى تجربة مستخدم غير موحدة ومربكة.

**التحليل:** نبعت المشكلة من أن الااستايلات الجديدة تم إضافتها كحل سريع دون دمجها في البنية الأساسية. كانت البيانات والترجمات متناثرة بين ملف `JSON` وملفات الترجمة، وكان مكون `SettingsPanel.tsx` يعرض قائمتين بشكل غير فعال.

**الحل:** تم إجراء إعادة هيكلة شاملة لمركزة البيانات وتوحيد واجهة المستخدم.

1.  **مركزة الترجمات والبيانات:**
    *   تم إنشاء كائن جديد `specialStyles` داخل `tooltips` في ملفات الترجمة (`en.ts` و `ar.ts`).
    *   تم نقل جميع أسماء وأوصاف الااستايلات الـ 11 إلى هذا الكائن المركزي، مما يوفر مصدرًا واحدًا للحقيقة ويجعل الإضافات المستقبلية سهلة.
    *   تم تعديل ملف `local_image_prompt_components.json` ليحتوي فقط على `id` كل استايل، مفصولاً عن أي نصوص عرض.

2.  **إعادة هيكلة واجهة المستخدم (`SettingsPanel.tsx`):**
    *   **إزالة الازدواجية:** تم حذف القائمة المنسدلة القديمة ("النمط") تمامًا.
    *   **توحيد القائمة:** تم الاعتماد على قائمة منسدلة واحدة فقط (`CustomSelect` للاستايل)، والتي أصبحت الآن المصدر الوحيد لاختيار الاستايل.
    *   **الربط الديناميكي:** تم تعديل الكود ليقوم بما يلي:
        *   جلب خيارات القائمة (`id` و `label`) من `imageComponents.styles` وملفات الترجمة `specialStyles` بشكل ديناميكي.
        *   عرض الوصف المرافق للاستايل المختار مباشرة من ملف الترجمة بناءً على `settings.style`.

**النتيجة:** أصبحت تجربة المستخدم الآن سلسة وموحدة. هناك قائمة واحدة فقط لـ "الاستايل" تعرض جميع الخيارات المتاحة مع وصف ديناميكي واضح لكل خيار، مع دعم كامل للغتين العربية والإنجليزية. هذا التحسين لا يعزز تجربة المستخدم فحسب، بل يجعل الكود أكثر نظافة وقابلية للصيانة.

---

### خلل: عرض تكلفة التوليد الثابتة

**المشكلة:** كانت التكلفة المعروضة على زر "توليد" ثابتة ولا تتغير عند تبديل المستخدم بين أوضاع التوليد (صورة، فيديو، نص). كانت التكلفة مكتوبة بشكل ثابت في متغيرات ترجمة منفصلة (`costGenerateImage`, `costGenerateVideo`, `costGenerateText`).

**التحليل:** نبعت المشكلة من أن المكون الرئيسي (`prompt_master_v4.1.tsx`) كان يستخدم نصوص ترجمة ثابتة ومنفصلة بدلاً من قيمة ديناميكية تعكس وضع التوليد الحالي.

**الحل:** تم إجراء إعادة هيكلة للكود لتوسيط منطق حساب التكلفة وجعل العرض ديناميكيًا.

1.  **توسيط منطق حساب التكلفة**: تم نقل المنطق الأساسي لحساب تكلفة التوليد إلى الهوك المخصص `usePromptGeneration.ts`. هذا الهوك أصبح الآن يوفر متغير الحالة `generationCost` الذي يحتوي دائمًا على التكلفة الصحيحة بناءً على الوضع (`mode`) المحدد حاليًا.

2.  **إعادة هيكلة متغيرات الترجمة**: تم استبدال متغيرات الترجمة المتعددة الثابتة بمتغير واحد أكثر مرونة: `costGenerate`. تم تحديث هذا في ملفي `en.ts` و `ar.ts`.
